-- ===============================
-- fission reactor monitor v0.2
-- based on v0.1 (working version)
-- ===============================

-- peripherals
local reactor = peripheral.wrap("fissionReactorLogicAdapter_0")
if not reactor then
  error("no reactor found")
end

local monitor = peripheral.wrap("monitor_7")
if not monitor then
  error("no monitor found")
end

monitor.setTextScale(0.5)
monitor.setBackgroundColor(colors.black)
monitor.clear()

-- helpers
local function pct(v, max)
  if not v or not max or max == 0 then
    return "n/a"
  end
  return string.format("%.1f%%", (v / max) * 100)
end

local function bar(y, label, v, max)
  local w = 30
  monitor.setCursorPos(2, y)
  monitor.write(label)

  monitor.setCursorPos(12, y)
  monitor.write("[")

  local fill = 0
  if v and max and max > 0 then
    fill = math.floor((v / max) * w)
  end

  for i = 1, w do
    if i <= fill then
      monitor.write("=")
    else
      monitor.write("-")
    end
  end

  monitor.write("]")
end

-- main loop
while true do
  monitor.clear()

  -- title
  monitor.setCursorPos(2, 1)
  monitor.setTextColor(colors.cyan)
  monitor.write("control fission reactor")

  monitor.setCursorPos(2, 2)
  monitor.setTextColor(colors.gray)
  monitor.write("fissionreactorlogicadapter_0")

  -- state
  local active = reactor.getStatus()
  monitor.setCursorPos(2, 4)
  monitor.setTextColor(colors.white)
  monitor.write("state: ")
  if active then
    monitor.setTextColor(colors.green)
    monitor.write("on")
  else
    monitor.setTextColor(colors.red)
    monitor.write("off")
  end

  -- temperature (kelvin -> celsius)
  local tempk = reactor.getTemperature()
  monitor.setCursorPos(2, 6)
  monitor.setTextColor(colors.white)
  if tempk then
    monitor.write(string.format("temp: %.1f c", tempk - 273.15))
  else
    monitor.write("temp: n/a")
  end

  -- values
  local coolant = reactor.getCoolant()
  local coolantmax = reactor.getCoolantCapacity()

  local fuel = reactor.getFuel()
  local fuelmax = reactor.getFuelCapacity()

  local waste = reactor.getWaste()
  local wastemax = reactor.getWasteCapacity()

  local heated = reactor.getHeatedCoolant()
  local heatedmax = reactor.getHeatedCoolantCapacity()

  -- bars
  bar(8,  "coolant", coolant, coolantmax)
  bar(9,  "fuel   ", fuel, fuelmax)
  bar(10, "waste  ", waste, wastemax)
  bar(11, "heated ", heated, heatedmax)

  -- percentages
  monitor.setCursorPos(2, 13)
  monitor.setTextColor(colors.lightBlue)
  monitor.write("coolant: " .. pct(coolant, coolantmax))

  monitor.setCursorPos(2, 14)
  monitor.setTextColor(colors.green)
  monitor.write("fuel   : " .. pct(fuel, fuelmax))

  monitor.setCursorPos(2, 15)
  monitor.setTextColor(colors.purple)
  monitor.write("waste  : " .. pct(waste, wastemax))

  monitor.setCursorPos(2, 16)
  monitor.setTextColor(colors.orange)
  monitor.write("heated : " .. pct(heated, heatedmax))

  -- burn rate
  monitor.setCursorPos(2, 18)
  monitor.setTextColor(colors.white)
  monitor.write(string.format(
    "burn: %.2f / %.2f",
    reactor.getBurnRate(),
    reactor.getMaxBurnRate()
  ))

  sleep(0.5)
end
