-- controle reacteur fission v0.6
-- cc:tweaked + mekanism fission reactor logic adapter
-- important: garder les majuscules des methodes (getTemperature, getCoolantFilledPercentage, etc)

-------------------------
-- config
-------------------------
local MONITOR_NAME = "monitor_9"
local REACTOR_NAME = "fissionReactorLogicAdapter_1"

local TEXT_SCALE = 1.8
local LOOP_SEC = 0.5

local AUTO_SIDE = "left"
local AUTO_DEFAULT = true

local COOL_TARGET = 0.45
local COOL_LOW = 0.40
local COOL_HIGH = 0.80

local MIN_BURN = 0.20
local MAX_BURN = 375.00

local RAMP_UP = 1.5
local RAMP_DOWN = 3.0
local STABLE_BONUS = 0.25
local STABLE_EPS = 0.001

local DAMAGE_LOCK = 30.0
local TEMP_LOCK_C = 1200.0
local HEATED_LOCK = 0.95
local WASTE_LOCK = 0.95

-------------------------
-- helpers
-------------------------
local function clamp(x, a, b)
  if x < a then return a end
  if x > b then return b end
  return x
end

local function fmtNum(x, decimals)
  if type(x) ~= "number" then return "n/a" end
  local m = 10 ^ (decimals or 0)
  local v = math.floor(x * m + 0.5) / m
  return tostring(v)
end

local function safeCall(fn)
  local ok, res = pcall(fn)
  if ok then return true, res end
  return false, nil
end

local function bar(pct, width)
  if type(pct) ~= "number" then
    return "[" .. string.rep("-", width) .. "]"
  end
  pct = clamp(pct, 0, 1)
  local fill = math.floor(pct * width + 0.5)
  fill = clamp(fill, 0, width)
  return "[" .. string.rep("#", fill) .. string.rep("-", width - fill) .. "]"
end

-------------------------
-- peripherals
-------------------------
local mon = peripheral.wrap(MONITOR_NAME)
if not mon then error("monitor introuvable: " .. tostring(MONITOR_NAME)) end
mon.setTextScale(TEXT_SCALE)

local reactor = peripheral.wrap(REACTOR_NAME)
if not reactor then
  reactor = peripheral.find("fissionReactorLogicAdapter")
end
if not reactor then error("reacteur introuvable (type fissionReactorLogicAdapter)") end

local reactorDisplayName = peripheral.getName(reactor) or REACTOR_NAME

-------------------------
-- ui sans clignotement
-------------------------
local lastLine = {}

local function writeLine(y, text, fg, bg)
  local w, h = mon.getSize()
  if y < 1 or y > h then return end

  text = tostring(text or "")
  if #text < w then
    text = text .. string.rep(" ", w - #text)
  else
    text = string.sub(text, 1, w)
  end

  local key = y .. ":" .. tostring(fg) .. ":" .. tostring(bg)
  if lastLine[key] == text then return end
  lastLine[key] = text

  mon.setCursorPos(1, y)
  if bg then mon.setBackgroundColor(bg) end
  if fg then mon.setTextColor(fg) end
  mon.write(text)
end

local function clearAll()
  mon.setBackgroundColor(colors.black)
  mon.clear()
  lastLine = {}
end

-------------------------
-- controle
-------------------------
local burnCmd = MIN_BURN
local lastCoolPct = nil
local locked = false
local lockReason = "-"

clearAll()

local function setBurn(rate)
  rate = clamp(rate, 0, MAX_BURN)
  safeCall(function() reactor.setBurnRate(rate) end)
end

local function scramNow(reason)
  locked = true
  lockReason = reason or "verrouillage"
  setBurn(0)
  safeCall(function() reactor.scram() end)
end

local function readAuto()
  local ok = pcall(function() return redstone.getInput(AUTO_SIDE) end)
  if ok then return redstone.getInput(AUTO_SIDE) end
  return AUTO_DEFAULT
end

-------------------------
-- boucle principale
-------------------------
while true do
  local w, h = mon.getSize()
  local barW = clamp(w - 22, 10, 60)

  local auto = readAuto()

  local okState, state = safeCall(function() return reactor.getStatus() end)
  local okTemp, tempK = safeCall(function() return reactor.getTemperature() end)
  local okHeatRate, heatRate = safeCall(function() return reactor.getHeatingRate() end)
  local okDamage, dmgPct = safeCall(function() return reactor.getDamagePercent() end)

  local okCoolPct, coolPct = safeCall(function() return reactor.getCoolantFilledPercentage() end)
  local okFuelPct, fuelPct = safeCall(function() return reactor.getFuelFilledPercentage() end)
  local okWastePct, wastePct = safeCall(function() return reactor.getWasteFilledPercentage() end)
  local okHeatedPct, heatedPct = safeCall(function() return reactor.getHeatedCoolantFilledPercentage() end)

  local okCoolTbl, coolTbl = safeCall(function() return reactor.getCoolant() end)
  local coolantName = "n/a"
  if okCoolTbl and type(coolTbl) == "table" and coolTbl.name then
    coolantName = tostring(coolTbl.name)
  end

  local okBurn, burnNow = safeCall(function() return reactor.getBurnRate() end)
  local okMaxBurn, maxBurn = safeCall(function() return reactor.getMaxBurnRate() end)

  local tempC = nil
  if okTemp and type(tempK) == "number" then
    tempC = tempK - 273.15
  end

  -- securites
  if not locked then
    if okDamage and type(dmgPct) == "number" and dmgPct >= DAMAGE_LOCK then
      scramNow("degats")
    elseif type(tempC) == "number" and tempC >= TEMP_LOCK_C then
      scramNow("temperature")
    elseif okHeatedPct and type(heatedPct) == "number" and heatedPct >= HEATED_LOCK then
      scramNow("liquide chauffe")
    elseif okWastePct and type(wastePct) == "number" and wastePct >= WASTE_LOCK then
      scramNow("dechets")
    end
  end

  -- regulation burn selon coolant
  if auto and (not locked) and okCoolPct and type(coolPct) == "number" then
    local dCool = 0
    if type(lastCoolPct) == "number" then
      dCool = coolPct - lastCoolPct
    end
    lastCoolPct = coolPct

    local stable = math.abs(dCool) <= STABLE_EPS
    local delta = 0

    if coolPct < COOL_LOW then
      local severity = (COOL_LOW - coolPct) / COOL_LOW
      delta = -RAMP_DOWN * (0.5 + severity)
    elseif coolPct < COOL_TARGET then
      local severity = (COOL_TARGET - coolPct) / (COOL_TARGET - COOL_LOW)
      delta = -RAMP_DOWN * 0.5 * severity
    else
      local gain = 1.0
      if coolPct > COOL_HIGH then gain = 0.6 end

      if stable then
        delta = (RAMP_UP * 0.4 * gain) + STABLE_BONUS
      else
        if dCool > 0 then
          delta = RAMP_UP * 1.0 * gain
        else
          delta = RAMP_UP * 0.3 * gain
        end
      end
    end

    burnCmd = clamp(burnCmd + delta, MIN_BURN, MAX_BURN)
    setBurn(burnCmd)
  else
    if okCoolPct and type(coolPct) == "number" then lastCoolPct = coolPct end
  end

  -- affichage
  writeLine(1, "controle reacteur fission", colors.cyan, colors.black)
  writeLine(2, reactorDisplayName, colors.lightGray, colors.black)

  local etatTxt = "n/a"
  if okState then etatTxt = state and "marche" or "arret" end

  local tempTxt = "n/a"
  if type(tempC) == "number" then tempTxt = fmtNum(tempC, 1) .. " c" end

  local heatTxt = "n/a"
  if okHeatRate and type(heatRate) == "number" then
    heatTxt = fmtNum(heatRate, 2) .. " mb/t"
  end

  local verrouTxt = locked and ("oui (" .. lockReason .. ")") or "non"
  local autoTxt = auto and "auto: oui" or "auto: non"

  local burnTxt = okBurn and type(burnNow) == "number" and fmtNum(burnNow, 2) or fmtNum(burnCmd, 2)
  local maxBurnTxt = okMaxBurn and type(maxBurn) == "number" and fmtNum(maxBurn, 2) or fmtNum(MAX_BURN, 2)

  writeLine(3, "etat: " .. etatTxt .. "   " .. autoTxt, colors.white, colors.black)
  writeLine(4, "temp: " .. tempTxt .. "   chauffe: " .. heatTxt, colors.white, colors.black)
  writeLine(5, "coolant: " .. coolantName .. "   burn: " .. burnTxt .. "/" .. maxBurnTxt, colors.white, colors.black)
  writeLine(6, "verrouillage: " .. verrouTxt .. "   cible coolant: " .. fmtNum(COOL_TARGET*100,0) .. "%", colors.white, colors.black)

  local function pctTxt(ok, v)
    if ok and type(v) == "number" then return fmtNum(v * 100, 1) .. "%" end
    return "n/a"
  end

  writeLine(8,  "coolant " .. bar(okCoolPct and coolPct or nil, barW) .. " " .. pctTxt(okCoolPct, coolPct), colors.lightBlue, colors.black)
  writeLine(9,  "fuel    " .. bar(okFuelPct and fuelPct or nil, barW) .. " " .. pctTxt(okFuelPct, fuelPct), colors.lime, colors.black)
  writeLine(10, "dechets " .. bar(okWastePct and wastePct or nil, barW) .. " " .. pctTxt(okWastePct, wastePct), colors.purple, colors.black)
  writeLine(11, "chauffe " .. bar(okHeatedPct and heatedPct or nil, barW) .. " " .. pctTxt(okHeatedPct, heatedPct), colors.yellow, colors.black)

  -- valeurs numeriques
  local okCoolCap, coolCap = safeCall(function() return reactor.getCoolantCapacity() end)
  local okFuelCap, fuelCap = safeCall(function() return reactor.getFuelCapacity() end)
  local okWasteCap, wasteCap = safeCall(function() return reactor.getWasteCapacity() end)
  local okHeatCap, heatCap = safeCall(function() return reactor.getHeatedCoolantCapacity() end)

  local coolAmt = (okCoolPct and okCoolCap and type(coolPct)=="number" and type(coolCap)=="number") and (coolPct * coolCap) or nil
  local fuelAmt = (okFuelPct and okFuelCap and type(fuelPct)=="number" and type(fuelCap)=="number") and (fuelPct * fuelCap) or nil
  local wasteAmt = (okWastePct and okWasteCap and type(wastePct)=="number" and type(wasteCap)=="number") and (wastePct * wasteCap) or nil
  local heatAmt = (okHeatedPct and okHeatCap and type(heatedPct)=="number" and type(heatCap)=="number") and (heatedPct * heatCap) or nil

  local degatsTxt = "n/a"
  if okDamage and type(dmgPct)=="number" then degatsTxt = fmtNum(dmgPct, 1) .. "%" end

  writeLine(13, "coolant: " .. (coolAmt and (fmtNum(coolAmt,0) .. "/" .. fmtNum(coolCap,0) .. " mb") or "n/a"), colors.lightBlue, colors.black)
  writeLine(14, "fuel:    " .. (fuelAmt and (fmtNum(fuelAmt,0) .. "/" .. fmtNum(fuelCap,0) .. " mb") or "n/a"), colors.lime, colors.black)
  writeLine(15, "dechets: " .. (wasteAmt and (fmtNum(wasteAmt,0) .. "/" .. fmtNum(wasteCap,0) .. " mb") or "n/a"), colors.purple, colors.black)
  writeLine(16, "chauffe: " .. (heatAmt and (fmtNum(heatAmt,0) .. "/" .. fmtNum(heatCap,0) .. " mb") or "n/a"), colors.yellow, colors.black)

  writeLine(18, "degats: " .. degatsTxt .. " | limite burn: " .. fmtNum(MAX_BURN,0) .. " mb", colors.white, colors.black)

  sleep(LOOP_SEC)
end