-- reactor_code_v0_4_fixed.lua
-- cc:tweaked + mekanism fission reactor logic adapter
-- display: stable (no flicker), bars with dashes, numeric values + units

-- ===== config =====
local MONITOR_NAME = "monitor_7"
local REACTOR_NAME = "fissionReactorLogicAdapter_0"
local TEXT_SCALE   = 0.5      -- 0.5 / 1 / 1.5 / 2 (global text size)
local REFRESH_SEC  = 0.25

-- bar config
local BAR_W = 26              -- bar width in characters (will auto clamp to screen)

-- ===== peripherals =====
local mon = peripheral.wrap(MONITOR_NAME)
if not mon then error("monitor not found: " .. MONITOR_NAME) end

local reactor = peripheral.wrap(REACTOR_NAME)
if not reactor then error("reactor not found: " .. REACTOR_NAME) end

-- ===== monitor init =====
mon.setTextScale(TEXT_SCALE)
mon.setBackgroundColor(colors.black)
mon.setTextColor(colors.white)
mon.clear()

local W, H = mon.getSize()

-- clamp bar width to screen
BAR_W = math.max(10, math.min(BAR_W, W - 12))

-- ===== helpers =====
local last_lines = {}

local function padRight(s, n)
  s = tostring(s or "")
  if #s >= n then return s end
  return s .. string.rep(" ", n - #s)
end

local function setColor(c)
  mon.setTextColor(c)
end

local function drawLine(y, leftText, leftColor, rightText, rightColor)
  if y < 1 or y > H then return end
  leftText = leftText or ""
  rightText = rightText or ""

  -- build full line in one string for caching
  local full = leftText .. "\0" .. rightText .. "\0" .. tostring(leftColor or -1) .. "\0" .. tostring(rightColor or -1)
  if last_lines[y] == full then return end
  last_lines[y] = full

  -- clear line
  mon.setCursorPos(1, y)
  mon.write(string.rep(" ", W))

  -- write left
  mon.setCursorPos(1, y)
  if leftColor then setColor(leftColor) else setColor(colors.white) end
  mon.write(leftText)

  -- write right (aligned)
  local rx = W - #rightText + 1
  if rx < 1 then rx = 1 end
  mon.setCursorPos(rx, y)
  if rightColor then setColor(rightColor) else setColor(colors.white) end
  mon.write(rightText)

  setColor(colors.white)
end

local function safeCall(fn)
  local ok, v = pcall(fn)
  if ok then return true, v end
  return false, v
end

local function fmtNum(n, decimals)
  if n == nil then return "n/a" end
  if type(n) ~= "number" then return tostring(n) end
  decimals = decimals or 1
  local p = 10 ^ decimals
  return tostring(math.floor(n * p + 0.5) / p)
end

local function fmtPct(p)
  if p == nil then return "n/a" end
  if type(p) ~= "number" then return tostring(p) end
  return fmtNum(p * 100, 1) .. "%"
end

local function bar(p)
  if p == nil or type(p) ~= "number" then
    return "[" .. string.rep("-", BAR_W) .. "]"
  end
  if p < 0 then p = 0 end
  if p > 1 then p = 1 end
  local fill = math.floor(p * BAR_W + 0.5)
  if fill < 0 then fill = 0 end
  if fill > BAR_W then fill = BAR_W end
  return "[" .. string.rep("#", fill) .. string.rep("-", BAR_W - fill) .. "]"
end

local function colorByName(name)
  if name == "coolant" then return colors.lightBlue end
  if name == "fuel" then return colors.lime end
  if name == "waste" then return colors.purple end
  if name == "heated" then return colors.orange end
  return colors.white
end

-- ===== main loop =====
while true do
  W, H = mon.getSize()

  -- header
  drawLine(1, "control fission reactor", colors.cyan, "", colors.white)
  drawLine(2, REACTOR_NAME, colors.gray, "", colors.white)

  -- reactor status
  local okStatus, status = safeCall(function() return reactor.getStatus() end)
  local stateTxt = okStatus and (status and "on" or "off") or "n/a"
  local stateCol = (stateTxt == "on") and colors.lime or (stateTxt == "off" and colors.red or colors.lightGray)

  local okTemp, temp = safeCall(function() return reactor.getTemperature() end)
  local tempTxt = okTemp and (fmtNum(temp, 1) .. " c") or "n/a"

  drawLine(4, "state: " .. stateTxt, stateCol, "temp: " .. tempTxt, colors.yellow)

  -- heating rate + coolant type
  local okHeatRate, heatRate = safeCall(function() return reactor.getHeatingRate() end)
  local heatTxt = okHeatRate and (fmtNum(heatRate, 1) .. " mb/t") or "n/a"

  local okCoolant, coolantTbl = safeCall(function() return reactor.getCoolant() end)
  local coolantType = "n/a"
  if okCoolant and type(coolantTbl) == "table" then
    coolantType = tostring(coolantTbl.name or "n/a")
  end

  drawLine(5, "heat: " .. heatTxt, colors.orange, "cool: " .. coolantType, colors.lightBlue)

  -- percentages (filled)
  local okCFP, coolantPct = safeCall(function() return reactor.getCoolantFilledPercentage() end)
  local okFFP, fuelPct    = safeCall(function() return reactor.getFuelFilledPercentage() end)
  local okWFP, wastePct   = safeCall(function() return reactor.getWasteFilledPercentage() end)
  local okHFP, heatedPct  = safeCall(function() return reactor.getHeatedCoolantFilledPercentage() end)

  coolantPct = okCFP and coolantPct or nil
  fuelPct    = okFFP and fuelPct or nil
  wastePct   = okWFP and wastePct or nil
  heatedPct  = okHFP and heatedPct or nil

  -- bars + pct text
  local y0 = 7
  drawLine(y0 + 0, "coolant " .. bar(coolantPct), colorByName("coolant"), fmtPct(coolantPct), colorByName("coolant"))
  drawLine(y0 + 1, "fuel    " .. bar(fuelPct),    colorByName("fuel"),    fmtPct(fuelPct),    colorByName("fuel"))
  drawLine(y0 + 2, "waste   " .. bar(wastePct),   colorByName("waste"),   fmtPct(wastePct),   colorByName("waste"))
  drawLine(y0 + 3, "heated  " .. bar(heatedPct),  colorByName("heated"),  fmtPct(heatedPct),  colorByName("heated"))

  -- numeric values (amount/capacity)
  local okCC, coolantCap = safeCall(function() return reactor.getCoolantCapacity() end)
  local okFC, fuelCap    = safeCall(function() return reactor.getFuelCapacity() end)
  local okWC, wasteCap   = safeCall(function() return reactor.getWasteCapacity() end)
  local okHC, heatedCap  = safeCall(function() return reactor.getHeatedCoolantCapacity() end)

  local okFuel, fuelTbl  = safeCall(function() return reactor.getFuel() end)
  local okWaste, wasteTbl= safeCall(function() return reactor.getWaste() end)
  local okHeated, heatedTbl = safeCall(function() return reactor.getHeatedCoolant() end)

  local coolantAmt = (okCoolant and type(coolantTbl)=="table") and coolantTbl.amount or nil
  local fuelAmt    = (okFuel and type(fuelTbl)=="table") and fuelTbl.amount or nil
  local wasteAmt   = (okWaste and type(wasteTbl)=="table") and wasteTbl.amount or nil
  local heatedAmt  = (okHeated and type(heatedTbl)=="table") and heatedTbl.amount or nil

  local y1 = y0 + 5
  drawLine(y1 + 0, "coolant: " .. fmtNum(coolantAmt,0) .. "/" .. fmtNum(okCC and coolantCap or nil,0) .. " mb", colors.lightBlue, "", colors.white)
  drawLine(y1 + 1, "fuel:    " .. fmtNum(fuelAmt,0)    .. "/" .. fmtNum(okFC and fuelCap or nil,0)    .. " mb", colors.lime, "", colors.white)
  drawLine(y1 + 2, "waste:   " .. fmtNum(wasteAmt,0)   .. "/" .. fmtNum(okWC and wasteCap or nil,0)   .. " mb", colors.purple, "", colors.white)
  drawLine(y1 + 3, "heated:  " .. fmtNum(heatedAmt,0)  .. "/" .. fmtNum(okHC and heatedCap or nil,0)  .. " mb", colors.orange, "", colors.white)

  -- damage + burn
  local okDmg, dmg = safeCall(function() return reactor.getDamagePercent() end)
  local okBR, burn = safeCall(function() return reactor.getBurnRate() end)
  local okMBR, maxBurn = safeCall(function() return reactor.getMaxBurnRate() end)

  local dmgTxt = okDmg and (fmtNum(dmg,1) .. "%") or "n/a"
  local burnTxt = (okBR and okMBR) and (fmtNum(burn,2) .. " / " .. fmtNum(maxBurn,2)) or "n/a"

  drawLine(y1 + 5, "damage: " .. dmgTxt, colors.red, "burn: " .. burnTxt, colors.green)

  -- error indicator (top right)
  local errCount = 0
  if not okStatus then errCount = errCount + 1 end
  if not okTemp then errCount = errCount + 1 end
  if not okCFP then errCount = errCount + 1 end
  if not okFFP then errCount = errCount + 1 end
  if not okWFP then errCount = errCount + 1 end
  if not okHFP then errCount = errCount + 1 end

  local errTxt = (errCount > 0) and ("err: " .. errCount) or "ok"
  local errCol = (errCount > 0) and colors.red or colors.lime
  drawLine(2, REACTOR_NAME, colors.gray, errTxt, errCol)

  sleep(REFRESH_SEC)
end