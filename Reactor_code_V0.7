-- reactor_code_v0_7_1.lua
-- coolant driven burn control with 40% threshold behavior (as requested)

local MONITOR_NAME = "monitor_7"
local REACTOR_NAME = "fissionReactorLogicAdapter_0"

local TEXT_SCALE   = 1.8
local REFRESH_SEC  = 0.25

-- auto lever
local AUTO_SIDE    = "left"
local AUTO_INVERT  = false

-- control behavior
local COOL_TARGET   = 0.40     -- 40%
local EPS_DELTA     = 0.002    -- 0.2% to detect real change
local STEP_UP       = 3.0      -- burn increase when coolant rising
local STEP_UP_SLOW  = 1.0      -- burn increase when coolant stable
local K_DOWN        = 900.0    -- proportional gain for decrease when coolant < 40% and falling
-- example: delta=-0.01 => decrease 9 mb/t per loop

-- burn limits
local MIN_BURN_FRAC = 0.10     -- 10% of max (=> 20 when max=200)

-- safeties
local COOL_STOP    = 0.05
local COOL_RESET   = 0.10

local HEAT_STOP    = 0.90
local HEAT_RESET   = 0.80

local WASTE_STOP   = 0.90
local WASTE_RESET  = 0.80

local DMG_STOP     = 30.0
local DMG_RESET    = 25.0

-- bars
local BAR_W = 26

-- peripherals
local mon = peripheral.wrap(MONITOR_NAME)
if not mon then error("monitor not found: " .. MONITOR_NAME) end

local reactor = peripheral.wrap(REACTOR_NAME)
if not reactor then error("reactor not found: " .. REACTOR_NAME) end

-- monitor init
mon.setTextScale(TEXT_SCALE)
mon.setBackgroundColor(colors.black)
mon.setTextColor(colors.white)
mon.clear()

local W, H = mon.getSize()
BAR_W = math.max(10, math.min(BAR_W, W - 12))

-- helpers
local last_lines = {}

local function setColor(c) mon.setTextColor(c) end

local function drawLine(y, leftText, leftColor, rightText, rightColor)
  if y < 1 or y > H then return end
  leftText = leftText or ""
  rightText = rightText or ""
  local full = leftText .. "\0" .. rightText .. "\0" .. tostring(leftColor or -1) .. "\0" .. tostring(rightColor or -1)
  if last_lines[y] == full then return end
  last_lines[y] = full

  mon.setCursorPos(1, y)
  mon.write(string.rep(" ", W))

  mon.setCursorPos(1, y)
  setColor(leftColor or colors.white)
  mon.write(leftText)

  local rx = W - #rightText + 1
  if rx < 1 then rx = 1 end
  mon.setCursorPos(rx, y)
  setColor(rightColor or colors.white)
  mon.write(rightText)

  setColor(colors.white)
end

local function safeCall(fn)
  local ok, v = pcall(fn)
  if ok then return true, v end
  return false, v
end

local function fmtNum(n, d)
  if n == nil then return "n/a" end
  if type(n) ~= "number" then return tostring(n) end
  d = d or 1
  local p = 10 ^ d
  return tostring(math.floor(n * p + 0.5) / p)
end

local function fmtPct(p)
  if p == nil or type(p) ~= "number" then return "n/a" end
  return fmtNum(p * 100, 1) .. "%"
end

local function bar(p)
  if p == nil or type(p) ~= "number" then
    return "[" .. string.rep("-", BAR_W) .. "]"
  end
  if p < 0 then p = 0 end
  if p > 1 then p = 1 end
  local fill = math.floor(p * BAR_W + 0.5)
  if fill < 0 then fill = 0 end
  if fill > BAR_W then fill = BAR_W end
  return "[" .. string.rep("#", fill) .. string.rep("-", BAR_W - fill) .. "]"
end

local function clamp(x, a, b)
  if x < a then return a end
  if x > b then return b end
  return x
end

local function readAuto()
  local s = redstone.getInput(AUTO_SIDE)
  if AUTO_INVERT then s = not s end
  return s
end

-- state
local locked = false
local locked_reason = "-"
local last_burn_set = nil
local last_cool = nil

while true do
  local auto_on = readAuto()

  local okForce, forceDisabled = safeCall(function() return reactor.isForceDisabled() end)
  forceDisabled = okForce and forceDisabled or false

  local okStatus, isOn = safeCall(function() return reactor.getStatus() end)
  local stateTxt = okStatus and (isOn and "on" or "off") or "n/a"

  local okDmg, dmg = safeCall(function() return reactor.getDamagePercent() end)

  local okCFP, coolPct = safeCall(function() return reactor.getCoolantFilledPercentage() end)
  local okWFP, wastePct = safeCall(function() return reactor.getWasteFilledPercentage() end)
  local okHFP, heatPct  = safeCall(function() return reactor.getHeatedCoolantFilledPercentage() end)

  local okBR, burn = safeCall(function() return reactor.getBurnRate() end)
  local okMBR, maxBurn = safeCall(function() return reactor.getMaxBurnRate() end)

  -- ===== safeties =====
  local trip = nil
  if forceDisabled then
    trip = "forced"
  elseif okDmg and type(dmg)=="number" and dmg >= DMG_STOP then
    trip = "damage lock"
  elseif okCFP and type(coolPct)=="number" and coolPct <= COOL_STOP then
    trip = "coolant low"
  elseif okHFP and type(heatPct)=="number" and heatPct >= HEAT_STOP then
    trip = "heated high"
  elseif okWFP and type(wastePct)=="number" and wastePct >= WASTE_STOP then
    trip = "waste high"
  end

  if trip ~= nil then
    locked = true
    locked_reason = trip
    safeCall(function() reactor.scram() end)
  end

  if locked and (not forceDisabled) then
    local cool_ok  = (not okCFP) or (type(coolPct)~="number") or (coolPct >= COOL_RESET)
    local heat_ok  = (not okHFP) or (type(heatPct)~="number") or (heatPct <= HEAT_RESET)
    local waste_ok = (not okWFP) or (type(wastePct)~="number") or (wastePct <= WASTE_RESET)
    local dmg_ok   = (not okDmg) or (type(dmg)~="number") or (dmg <= DMG_RESET)

    if cool_ok and heat_ok and waste_ok and dmg_ok then
      locked = false
      locked_reason = "-"
    end
  end

  -- ===== auto control =====
  if auto_on and (not locked) and (not forceDisabled) then
    if okStatus and (not isOn) then
      safeCall(function() reactor.activate() end)
    end

    if okMBR and type(maxBurn)=="number" then
      local minBurn = maxBurn * MIN_BURN_FRAC
      local cur = (okBR and type(burn)=="number") and burn or last_burn_set or minBurn

      if last_cool == nil and type(coolPct)=="number" then
        last_cool = coolPct
      end

      local next = cur

      if type(coolPct) == "number" and last_cool ~= nil then
        local delta = coolPct - last_cool

        -- 1) coolant rising => increase burn (fast)
        if delta > EPS_DELTA then
          next = cur + STEP_UP

        -- 2) coolant stable => increase burn (slow)
        elseif math.abs(delta) <= EPS_DELTA then
          next = cur + STEP_UP_SLOW

        -- 3) coolant falling => only decrease if coolant < 40%
        elseif delta < -EPS_DELTA then
          if coolPct < COOL_TARGET then
            -- proportional to decrease amount
            next = cur - (math.abs(delta) * K_DOWN)
          else
            -- above 40%: do not decrease, keep searching equilibrium
            next = cur
          end
        end

        last_cool = coolPct
      end

      next = clamp(next, minBurn, maxBurn)

      if (last_burn_set == nil) or (math.abs(next - last_burn_set) >= 0.01) then
        safeCall(function() reactor.setBurnRate(next) end)
        last_burn_set = next
      end
    end
  else
    last_burn_set = nil
    last_cool = nil
  end

  -- ===== ui =====
  drawLine(1, "control fission reactor", colors.cyan, "", colors.white)
  drawLine(2, REACTOR_NAME, colors.gray,
    locked and ("lock: " .. locked_reason) or (forceDisabled and "forced") or "ok",
    (locked or forceDisabled) and colors.red or colors.lime
  )

  local autoTxt = auto_on and "auto:on" or "auto:off"
  local autoCol = auto_on and colors.lime or colors.red
  local stateCol = (stateTxt == "on") and colors.lime or (stateTxt == "off" and colors.red or colors.lightGray)

  drawLine(4, autoTxt, autoCol, "state: " .. stateTxt, stateCol)

  local burnTxt = (okBR and okMBR) and (fmtNum(burn,1) .. "/" .. fmtNum(maxBurn,0)) or "n/a"
  drawLine(5, "cool target: " .. fmtPct(COOL_TARGET), colors.yellow, "burn: " .. burnTxt, colors.green)

  local y0 = 7
  drawLine(y0 + 0, "coolant " .. bar(okCFP and coolPct or nil), colors.lightBlue, fmtPct(okCFP and coolPct or nil), colors.lightBlue)
  drawLine(y0 + 1, "heated  " .. bar(okHFP and heatPct or nil), colors.orange, fmtPct(okHFP and heatPct or nil), colors.orange)
  drawLine(y0 + 2, "waste   " .. bar(okWFP and wastePct or nil), colors.purple, fmtPct(okWFP and wastePct or nil), colors.purple)

  local dmgTxt = okDmg and (fmtNum(dmg,1) .. "%") or "n/a"
  drawLine(H, "damage: " .. dmgTxt .. " | lever " .. AUTO_SIDE, colors.gray, "", colors.white)

  sleep(REFRESH_SEC)
end